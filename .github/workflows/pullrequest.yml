name:  Build and test

on:
  pull_request:
    branches: [ master ]

jobs:
  runhaskell:
    name: Build and test
    runs-on: ubuntu-latest # or macOS-latest, or windows-latest
    # container: timescale/timescaledb-ha:pg14-latest 
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      # - uses: actions/checkout@v2
      # - uses: freckle/stack-cache-action@main
      # - uses: haskell/actions/setup@v1
      #   with:
      #     ghc-version: "9.2.7" # Exact version of ghc to use
      #     # cabal-version: 'latest'. Omitted, but defalts to 'latest'
      #     enable-stack: true
      #     stack-version: "latest"

      # - run: stack --no-terminal build --dependencies-only
      # - run: stack install --local-bin-path=.
      #
      - name: Add repositories
        run: |
          sudo apt-get update
          sudo apt-get install -y wget lsb-release gnupg apt-transport-https sudo postgresql-common
          sudo /usr/share/postgresql-common/pgdg/apt.postgresql.org.sh -v 14 -p -i
          # sudo echo "deb https://packagecloud.io/timescale/timescaledb/ubuntu/ $(lsb_release -c -s) main" \
          #   > /etc/apt/sources.list.d/timescaledb.list
          echo "deb https://packagecloud.io/timescale/timescaledb/ubuntu/ $(lsb_release -c -s) main" | sudo tee /etc/apt/sources.list.d/timescaledb.list
          wget --quiet -O - https://packagecloud.io/timescale/timescaledb/gpgkey | sudo apt-key add -

      - name: Install timescaledb
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends timescaledb-2-postgresql-14 timescaledb-tools
          timescaledb-tune --quiet --yes
      # - name: "Install postgresql"
      #   run: |
      #     sudo apt-get install gnupg postgresql-common apt-transport-https lsb-release wget
      #     /usr/share/postgresql-common/pgdg/apt.postgresql.org.sh
      #     echo "deb https://packagecloud.io/timescale/timescaledb/ubuntu/ $(lsb_release -c -s) main" | sudo tee /etc/apt/sources.list.d/timescaledb.list
      #     wget --quiet -O - https://packagecloud.io/timescale/timescaledb/gpgkey | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/timescaledb.gpg
      #     apt update 
      #     apt install timescaledb-2-postgresql-14

      #     sudo apt-get update -qq
      #     sudo apt-get -y install gnupg postgresql-common apt-transport-https lsb-release wget
      #     sudo /usr/share/postgresql-common/pgdg/apt.postgresql.org.sh -v 14 -p -i
      #     echo "deb https://packagecloud.io/timescale/timescaledb/ubuntu/ $(lsb_release -c -s) main" | sudo tee /etc/apt/sources.list.d/timescaledb.list
      #     wget --quiet -O - https://packagecloud.io/timescale/timescaledb/gpgkey | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/timescaledb.gpg
      #     sudo -u postgres createuser -s "postgres"
      # # - run: stack test


