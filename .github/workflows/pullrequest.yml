name:  Build and test

on:
  pull_request:
    branches: [ master ]

env:
  LANG: C.UTF-8

jobs:
  runhaskell:
    name: Build and test
    runs-on: ubuntu-latest # or macOS-latest, or windows-latest
    # container: timescale/timescaledb-ha:pg14-latest 
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - uses: actions/checkout@v3
      - uses: haskell-actions/run-fourmolu@v9
        with:
          version: "0.16.2.0"
      - uses: freckle/stack-cache-action@main
      - uses: haskell/actions/setup@v1
        with:
          ghc-version: "9.2.7" # Exact version of ghc to use
          # cabal-version: 'latest'. Omitted, but defalts to 'latest'
          enable-stack: true
          stack-version: "latest"

      - run: stack --no-terminal build --dependencies-only
      - run: stack install --local-bin-path=.

      # https://github.com/marketplace/actions/cache-apt-packages#example-workflow
      - uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages:  wget lsb-release gnupg apt-transport-https postgresql-common
          version: 1.0
      - name: Install timescaledb
        run: |
          sudo /usr/share/postgresql-common/pgdg/apt.postgresql.org.sh -v 14 -p -i
          echo "deb https://packagecloud.io/timescale/timescaledb/ubuntu/ $(lsb_release -c -s) main" | sudo tee /etc/apt/sources.list.d/timescaledb.list
          wget --quiet -O - https://packagecloud.io/timescale/timescaledb/gpgkey | sudo apt-key add -
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends timescaledb-2-postgresql-14 timescaledb-tools timescaledb-toolkit-postgresql-14
          sudo timescaledb-tune --quiet --yes

      - name: stack test
        run: |
          export PATH=$PATH:/usr/lib/postgresql/14/bin
          stack test
