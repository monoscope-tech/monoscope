name: Build and Test PR

on: pull_request

env:
  LANG: C.UTF-8

jobs:
  build:
    name: Build
    runs-on: ubuntu-24.04
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libssl-dev librdkafka-dev libgrpc-dev protobuf-compiler libsnappy-dev libpq-dev libldap2-dev libsasl2-dev liblz4-dev libzstd-dev pkg-config
          version: 1.0

      - name: Set OpenSSL environment variables
        run: |
          echo "OPENSSL_INCLUDE_DIR=$(pkg-config --variable=includedir openssl)" >> $GITHUB_ENV
          echo "OPENSSL_LIB_DIR=$(pkg-config --variable=libdir openssl)" >> $GITHUB_ENV

      - uses: haskell-actions/setup@v2
        with:
          ghc-version: 9.12.2
          cabal-version: 'latest'
      - name: Cache Haskell dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cabal/store
            dist-newstyle
          key: ${{ runner.os }}-cabal-${{ hashFiles('**/*.cabal', '**/cabal.project*') }}
          restore-keys: |
            ${{ runner.os }}-cabal-

      - name: Setup node env
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Generate required static files
        run: |
          mkdir -p static/public/assets/css
          mkdir -p static/public/assets/web-components/dist/js
          mkdir -p static/public/assets/web-components/dist/css

          npm install
          npx tailwindcss -i ./static/public/assets/css/tailwind.css -o ./static/public/assets/css/tailwind.min.css --minify

          cd web-components
          npm install
          NODE_ENV=production npx vite build --mode production --sourcemap false
          cd ..

      - name: Update cabal index
        run: cabal update

      - name: Configure project
        run: cabal configure --enable-tests --enable-benchmarks --ghc-options="-O0 -j8"

      - name: Build dependencies
        run: cabal build --only-dependencies all -j4

      - name: Build project with HIE files
        run: cabal build all -j4 --ghc-options="-fwrite-ide-info -hiedir=.hiefiles"

      - name: Upload weeder artifacts
        uses: actions/upload-artifact@v4
        with:
          name: weeder-artifacts
          path: |
            .hiefiles
            dist-newstyle/**/*.conf
          retention-days: 1

  test:
    name: Test ${{ matrix.test-suite }}
    needs: build
    if: always()
    runs-on: ubuntu-24.04
    services:
      postgres:
        image: timescale/timescaledb-ha:pg16-all
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: monoscope
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        ports:
          - 5432:5432
    strategy:
      fail-fast: false
      matrix:
        test-suite: [doctests, unit-tests, integration-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libssl-dev librdkafka-dev libgrpc-dev protobuf-compiler libsnappy-dev libpq-dev libldap2-dev libsasl2-dev liblz4-dev libzstd-dev pkg-config
          version: 1.0

      - name: Set OpenSSL environment variables
        run: |
          echo "OPENSSL_INCLUDE_DIR=$(pkg-config --variable=includedir openssl)" >> $GITHUB_ENV
          echo "OPENSSL_LIB_DIR=$(pkg-config --variable=libdir openssl)" >> $GITHUB_ENV

      - uses: haskell-actions/setup@v2
        with:
          ghc-version: 9.12.2
          cabal-version: 'latest'

      - name: Cache Haskell dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cabal/store
            dist-newstyle
          key: ${{ runner.os }}-cabal-${{ hashFiles('**/*.cabal', '**/cabal.project*') }}
          restore-keys: |
            ${{ runner.os }}-cabal-

      - name: Setup node env
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Generate required static files
        run: |
          mkdir -p static/public/assets/css
          mkdir -p static/public/assets/web-components/dist/js
          mkdir -p static/public/assets/web-components/dist/css

          npm install
          npx tailwindcss -i ./static/public/assets/css/tailwind.css -o ./static/public/assets/css/tailwind.min.css --minify

          cd web-components
          npm install
          NODE_ENV=production npx vite build --mode production --sourcemap false
          cd ..

      - name: Update cabal index
        run: cabal update

      - name: Configure project
        run: cabal configure --enable-tests --enable-benchmarks --ghc-options="-O0 -j8"

      - name: Build dependencies
        run: cabal build --only-dependencies all -j4

      - name: Build ${{ matrix.test-suite }}
        run: cabal build ${{ matrix.test-suite }} -j4

      - name: Run ${{ matrix.test-suite }}
        env:
          USE_EXTERNAL_DB: true
        run: |
          echo "::group::Running ${{ matrix.test-suite }}"
          cabal test ${{ matrix.test-suite }} --ghc-options="-O0 -j8" --test-show-details=direct
          echo "::endgroup::"

  lint:
    name: Lint (hlint)
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: haskell-actions/hlint-setup@v2
      - name: Run hlint and apply refactorings
        id: hlint
        run: |
          hlint src/ --refactor --refactor-options="--inplace" || true
      - name: Commit and push refactorings
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          if [[ -n $(git status -s) ]]; then
            git add -A
            git commit -m "Apply hlint refactorings"
            git push
          fi
      - uses: haskell-actions/hlint-run@v2
        with:
          path: src/
          fail-on: warning

  weeder:
    name: Check unused code (weeder)
    needs: build
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - uses: haskell-actions/setup@v2
        with:
          ghc-version: 9.12.2
          cabal-version: 'latest'

      - name: Cache weeder
        id: cache-weeder
        uses: actions/cache@v4
        with:
          path: ~/.local/bin/weeder
          key: weeder-2.9.0-ghc-9.12.2

      - name: Install weeder
        if: steps.cache-weeder.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/.local/bin
          cabal update
          cabal install weeder-2.9.0 --install-method=copy --installdir=$HOME/.local/bin

      - name: Download weeder artifacts
        uses: actions/download-artifact@v4
        with:
          name: weeder-artifacts

      - name: Run weeder
        run: |
          if [ ! -d ".hiefiles" ]; then
            echo "Error: HIE files not found"
            exit 1
          fi
          ~/.local/bin/weeder --config config/weeder.toml

  ui-tests:
    name: UI Tests
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Setup node env
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Run UI tests
        run: |
          cd web-components
          npm install
          npm test
