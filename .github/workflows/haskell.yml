name: Haskell CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        ghc: ['8.2.2']
        cabal: ['3.6.2.0']
        os: [ubuntu-latest]
        resolver: ['https://raw.githubusercontent.com/commercialhaskell/stackage-snapshots/master/lts/18/18.yaml']
    name: ${{ matrix.resolver }} (${{ matrix.ghc }}/${{ matrix.cabal }})
    steps:

      - name: Check out
        uses: actions/checkout@v2
        
      
      - name: Check
        run: |
          ls
        
      - name: Setup Haskell
        uses: haskell/actions/setup@v1
        with:
          enable-stack: true
          stack-version: 'latest'
         
      - name: Versions
        run: |
          stack --version
          cabal --version
          ghc --version
      
      - name: write to file
        uses: DamianReeves/write-file-action@v1.0
        with:
          path: /home/runner/.stack/config.yaml     
          contents: |
            echo "allow-newer: true"
          write-mode: append
  
      - name: Build package
        run: |
          stack build --dependencies-only

      - name: Build testing dependencies
        run: |
          stack --resolver ${{ matrix.resolver }} build --no-run-tests --no-run-benchmarks --test --bench

      - name: Run tests
        run: |
          stack --resolver ${{ matrix.resolver }} build --test --no-run-benchmarks

      - name: Package list
        run: |
          stack --resolver ${{ matrix.resolver }} exec ghc-pkg list || true
