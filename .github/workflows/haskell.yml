name: Haskell CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  btp:
    name: Build-Tag-Push
    runs-on: ubuntu-16.04
    
    strategy:
      matrix:
        stack: [2.1.3]
    
    env:
      STACK_VERSON: ${{ matrix.stack }}

    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    
    - name: Prepare ~/.local/bin
      run: |
        mkdir -p ~/.local/bin
        export PATH=~/.local/bin:$PATH

# (1) -> Prepare Stack   
    - name: Setup stack
      run: |
        curl -L https://github.com/commercialhaskell/stack/releases/download/v$STACK_VERSON/stack-$STACK_VERSON-linux-x86_64.tar.gz | tar xz --wildcards --strip-components=1 -C ~/.local/bin '*/stack';
# (2) -> Build binary
    - name: List recursively . (before timestamp change)
      run: |
        ls -la -R .
    
    - name: Update timestamps from git
      run: | 
        git ls-tree -r --name-only HEAD | while read filename; do
          TS="$(git log -1 --format="%ct" -- ${filename})"
          echo $TS
          touch "${filename}" -mt "$(date --date="@$TS" "+%Y%m%d%H%M.%S")"
          echo "touch \"${filename}\" -mt \"$(date --date="@$TS" "+%Y%m%d%H%M.%S")\""
        done
        
    - name: List recursively . (before build)
      run: |
        ls -la -R .
    - name: Build application
      run: |
        stack build -v --no-terminal --skip-ghc-check
        
    - name: List recursively . (after build)
      run: |
        ls -la -R .
