title: Overview
icon: qrcode
preview: /public/assets/svgs/screens/http-stats.svg
description: Comprehensive system overview with service, resource, and database insights
refresh_interval: 60s

# Constants are query results executed once and reusable across all widgets
# They are available as {{const-<key>}} placeholders that expand to a subquery
constants:
  - key: top_resources
    description: Top 20 resources by request count for the current time range
    sql: |
      SELECT name
      FROM otel_logs_and_spans
      WHERE project_id='{{project_id}}'
        AND name IS NOT NULL
        AND kind = 'server'
        AND ('{{var-resource}}' = '' OR name = '{{var-resource}}')
        {{time_filter}}
      GROUP BY name
      ORDER BY COUNT(*) DESC
      LIMIT 20

variables:
  - key: service
    title: Service
    type: query
    reload_on_change: true
    sql: |
      SELECT DISTINCT resource___service___name 
      FROM otel_logs_and_spans 
      WHERE project_id='{{project_id}}' 
        AND resource___service___name IS NOT NULL 
        {{time_filter}}
      LIMIT 100
    default: ''
    multi: false

  - key: resource
    title: Resource/Operation
    type: query
    reload_on_change: true
    sql: |
      SELECT DISTINCT 
        name as value,
        name as label
      FROM otel_logs_and_spans
      WHERE project_id='{{project_id}}'
        AND resource___service___name = '{{var-service}}'
        AND name IS NOT NULL
        {{time_filter}}
      LIMIT 500
    default: ''
    multi: false
    depends_on: service

  - key: database
    title: Database System
    type: query
    sql: |
      SELECT DISTINCT attributes___db___system___name
      FROM otel_logs_and_spans
      WHERE project_id='{{project_id}}'
        AND attributes___db___system___name IS NOT NULL
        {{time_filter}}
      LIMIT 50
    default: ''
    multi: false

widgets: [] # Empty widgets array for backward compatibility

tabs:
  - name: Overview
    icon: grid
    widgets:
      # System Metrics
      - type: group
        title: System Metrics
        layout: { w: 12, h: 4 }
        children:
          - type: 'timeseries_stat'
            title: 'Total Requests'
            icon: list-tree
            query: |
              (kind == "server" or name == "apitoolkit-http-span" or name == "monoscope.http")
              | summarize count() by bin_auto(timestamp)
              | order by timestamp desc
              | limit 200
            unit: reqs
            eager: true
            layout: { w: 3, h: 2 }

          - type: 'stat'
            title: 'Global Error Rate'
            icon: bug
            query: |
              (kind == "server" or name == "apitoolkit-http-span")
              | summarize round(countif(status_code == "ERROR") * 100.0 / count(), 2)
            unit: '%'
            eager: true
            layout: { w: 3, h: 2 }

          - type: 'stat'
            title: 'Active Services'
            icon: server
            query: |
              resource.service.name != null
              | summarize dcount(resource.service.name)
            unit: services
            eager: true
            layout: { w: 3, h: 2 }

          - type: 'stat'
            title: 'DB Systems'
            icon: database
            query: |
              attributes.db.system.name != null
              | summarize dcount(attributes.db.system.name)
            unit: systems
            eager: true
            layout: { w: 3, h: 2 }

      # Services Table and Issues side by side
      - type: table
        title: Services Overview
        layout: { w: 6, h: 6 }
        on_row_click:
          set_variable: service
          value: '{{row.service_name}}'
          navigate_to_tab: 'Service Summary'
        columns:
          - field: service_name
            title: Service
          - field: throughput
            title: Throughput
            columnType: number
            unit: req/min
            progress: column_percent
          - field: error_rate
            title: Error Rate
            unit: '%'
            progress: value_percent
            progress_variant: error
          - field: p95_latency
            title: P95 Latency
            columnType: duration
            unit: ms
            progress: column_percent
        sql: |
          SELECT 
            resource___service___name as service_name,
            ROUND((COUNT(*)::numeric / GREATEST(1, EXTRACT(EPOCH FROM (MAX(timestamp) - MIN(timestamp))) / 60)), 2)::text as throughput,
            ROUND((COUNT(*) FILTER (WHERE status_code = 'ERROR') * 100.0 / GREATEST(1, COUNT(*))::numeric), 2)::text as error_rate,
            ROUND((approx_percentile(0.95, percentile_agg(duration))::numeric / 1e6), 2)::text as p95_latency
          FROM otel_logs_and_spans
          WHERE project_id='{{project_id}}' 
            AND resource___service___name IS NOT NULL
            AND kind = 'server'
            AND duration IS NOT NULL
            {{time_filter}}
          GROUP BY resource___service___name
          ORDER BY COUNT(*)::numeric / GREATEST(1, EXTRACT(EPOCH FROM (MAX(timestamp) - MIN(timestamp))) / 60) DESC
          LIMIT 50

      # Anomalies/Issues widget
      - type: anomalies
        title: 'Ongoing Issues'
        layout: { w: 6, h: 6 }

      # Events by Service
      - type: 'timeseries'
        title: 'Events by Service'
        query: |
          resource.service.name != null
          | summarize count() by bin_auto(timestamp), resource.service.name
          | order by timestamp desc
          | limit 10000
        unit: events
        layout: { w: 6, h: 4 }

      # Error Rates by Service
      - type: 'timeseries'
        title: 'Error Rates by Service'
        theme: 'roma'
        query: |
          status_code == "ERROR" and resource.service.name != null
          | summarize count() by bin_auto(timestamp), resource.service.name
          | order by timestamp desc
          | limit 10000
        unit: errors
        layout: { w: 6, h: 4 }

      # HTTP Request Volume by Service
      - type: 'timeseries'
        title: 'HTTP Request Volume by Service'
        query: |
          resource.service.name != null and kind == "server"
          | summarize count() by bin_auto(timestamp), resource.service.name
          | order by timestamp desc
          | limit 10000
        unit: reqs
        layout: { w: 6, h: 4 }

      # HTTP Requests by Status Code
      - type: 'timeseries'
        title: 'HTTP Requests by Status Code'
        query: |
          (kind == "server" or name == "apitoolkit-http-span" or name == "monoscope.http") and attributes.http.response.status_code != null
          | summarize count() by bin_auto(timestamp), coalesce(tostring(attributes.http.response.status_code), "unknown")
          | order by timestamp desc
          | limit 10000
        unit: reqs
        layout: { w: 6, h: 4 }

      # HTTP Errors Distribution
      - type: 'timeseries'
        title: 'HTTP Errors (4xx & 5xx) - Incoming'
        theme: 'roma'
        query: |
          (kind == "server" or name == "apitoolkit-http-span" or name == "monoscope.http") and attributes.http.response.status_code != null and attributes.http.response.status_code >= 400
          | extend error_category = case(attributes.http.response.status_code >= 500, "5xx", attributes.http.response.status_code >= 400, "4xx", tostring(attributes.http.response.status_code))
          | summarize count() by bin_auto(timestamp), error_category
          | order by timestamp desc
          | limit 10000
        unit: errors
        layout: { w: 6, h: 4 }

      # Request Latency Percentiles
      - type: 'timeseries_line'
        title: 'Request Latency Percentiles'
        hide_subtitle: true
        summarize_by: max
        query: |
          (kind == "server" or name == "apitoolkit-http-span" or name == "monoscope.http") and duration != null
          | summarize percentiles(duration, 50, 75, 90, 95, 99) by bin_auto(timestamp)
          | order by timestamp desc
        unit: ns
        layout: { w: 6, h: 4 }

      # Requests by Endpoint
      - type: 'timeseries'
        title: 'Requests by Endpoint'
        sql: |
          WITH top_endpoints AS (
            SELECT 
              attributes___http___request___method || ' ' || attributes___url___path as endpoint,
              COUNT(*) as total_count
            FROM otel_logs_and_spans
            WHERE project_id='{{project_id}}'
              AND (kind = 'server' OR name = 'apitoolkit-http-span' OR name = 'monoscope.http')
              AND attributes___http___response___status_code IS NOT NULL
              AND attributes___url___path IS NOT NULL
              {{time_filter}}
            GROUP BY endpoint
            ORDER BY total_count DESC
            LIMIT 10
          )
          SELECT 
            extract(epoch from time_bucket('{{rollup_interval}}', o.timestamp))::integer AS time,
            o.attributes___http___request___method || ' ' || o.attributes___url___path as endpoint,
            COUNT(*)::float as count
          FROM otel_logs_and_spans o
          INNER JOIN top_endpoints t ON (o.attributes___http___request___method || ' ' || o.attributes___url___path) = t.endpoint
          WHERE o.project_id='{{project_id}}'
            AND (o.kind = 'server' OR o.name = 'apitoolkit-http-span' OR o.name = 'monoscope.http')
            {{time_filter}}
          GROUP BY time, o.attributes___http___request___method, o.attributes___url___path
          ORDER BY time DESC
        unit: reqs
        layout: { w: 12, h: 4 }

  - name: Service Summary
    icon: server
    requires: service
    widgets:
      # Service Health Indicators
      - type: group
        title: '{{var-service}} Health'
        layout: { w: 12, h: 4 }
        children:
          - type: 'timeseries_stat'
            title: 'Service Requests'
            icon: list-tree
            query: |
              resource.service.name == "{{var-service}}" and kind == "server"
              | summarize count() by bin_auto(timestamp)
              | order by timestamp desc
              | limit 200
            unit: reqs
            layout: { w: 3, h: 2 }

          - type: 'stat'
            title: 'Service Error Rate'
            icon: bug
            query: |
              resource.service.name == "{{var-service}}" and kind == "server"
              | summarize round(countif(status_code == "ERROR" or coalesce(attributes.http.response.status_code, 0) >= 400) * 100.0 / count(), 2)
            unit: '%'
            layout: { w: 3, h: 2 }

          - type: 'stat'
            title: 'Avg Latency'
            icon: activity
            query: |
              resource.service.name == "{{var-service}}" and kind == "server" and duration != null
              | summarize round(avg(duration) / 1e6, 2)
            unit: ms
            layout: { w: 3, h: 2 }

          - type: 'stat'
            title: 'Endpoints'
            icon: routes
            query: |
              resource.service.name == "{{var-service}}" and kind == "server" and name != null
              | summarize dcount(name)
            unit: endpoints
            layout: { w: 3, h: 2 }

      # Total Service Requests by Status Code
      - type: 'timeseries'
        title: 'Total Service Requests'
        query: |
          resource.service.name == "{{var-service}}" and kind == "server"
          | extend status_code_str = coalesce(tostring(attributes.http.response.status_code), "unknown")
          | summarize count() by bin_auto(timestamp), status_code_str
          | order by timestamp desc
          | limit 10000
        unit: reqs
        layout: { w: 6, h: 4 }

      # Service Latency Percentiles
      - type: 'timeseries_line'
        title: 'Service Latency Percentiles'
        hide_subtitle: true
        summarize_by: max
        query: |
          resource.service.name == "{{var-service}}" and kind == "server" and duration != null
          | summarize percentiles(duration, 50, 75, 90, 95, 99) by bin_auto(timestamp)
          | order by timestamp desc
        unit: ns
        layout: { w: 6, h: 4 }

      # Service Errors (non-OK status codes)
      - type: 'timeseries'
        title: 'Service Errors'
        theme: 'roma'
        query: |
          resource.service.name == "{{var-service}}" and kind == "server" and (status_code != "UNSET" and status_code != "OK" or coalesce(attributes.http.response.status_code, 0) >= 400)
          | extend error_type = case(status_code == "ERROR", "ERROR", attributes.http.response.status_code >= 500, "5xx", attributes.http.response.status_code >= 400, "4xx", status_code)
          | summarize count() by bin_auto(timestamp), error_type
          | order by timestamp desc
          | limit 10000
        unit: errors
        layout: { w: 6, h: 4 }

      # Time Spent by Downstream Operations
      - type: 'timeseries'
        title: 'Time Spent by Downstream Operations'
        sql: |
          WITH service_spans AS (
            SELECT
              extract(epoch from time_bucket('{{rollup_interval}}', timestamp))::integer AS time,
              context___span_id as span_id,
              context___trace_id as trace_id
            FROM otel_logs_and_spans
            WHERE project_id='{{project_id}}'
              AND resource___service___name = '{{var-service}}'
              AND kind = 'server'
              {{time_filter}}
          ),
          downstream_time AS (
            SELECT
              ss.time,
              o.name as operation,
              SUM(o.duration)::float as duration_ns
            FROM otel_logs_and_spans o
            INNER JOIN service_spans ss ON o.context___trace_id = ss.trace_id AND o.parent_id = ss.span_id
            WHERE o.project_id='{{project_id}}'
              AND o.duration IS NOT NULL
              AND o.name IS NOT NULL
              {{time_filter}}
            GROUP BY ss.time, o.name
          )
          SELECT
            time,
            operation,
            duration_ns as value
          FROM downstream_time
          ORDER BY time DESC
          LIMIT 10000
        unit: ns
        layout: { w: 6, h: 4 }

      # Operations Table
      - type: table
        title: Operations
        layout: { w: 12, h: 6 }
        columns:
          - field: operation_name
            title: Operation
          - field: count
            title: Count
            columnType: number
            progress: column_percent
          - field: error_rate
            title: Error Rate
            unit: '%'
            progress: value_percent
            progress_variant: error
          - field: avg_duration
            title: Avg Duration
            columnType: duration
            unit: ms
            progress: column_percent
          - field: p95_duration
            title: P95 Duration
            columnType: duration
            unit: ms
            progress: column_percent
        sql: |
          SELECT 
            name as operation_name,
            COUNT(*)::text as count,
            ROUND((COUNT(*) FILTER (WHERE status_code = 'ERROR' OR COALESCE(attributes___http___response___status_code, 0) >= 400) * 100.0 / GREATEST(1, COUNT(*)))::numeric, 2)::text as error_rate,
            ROUND((AVG(duration) / 1e6)::numeric, 2)::text as avg_duration,
            ROUND((approx_percentile(0.95, percentile_agg(duration))::numeric / 1e6), 2)::text as p95_duration
          FROM otel_logs_and_spans
          WHERE project_id='{{project_id}}'
            AND resource___service___name = '{{var-service}}'
            AND name IS NOT NULL
            AND duration IS NOT NULL
            {{time_filter}}
          GROUP BY name
          ORDER BY COUNT(*) DESC
          LIMIT 100

  - name: Resources
    icon: routes
    widgets:
      # Three charts in one row - using {{const-top_resources}} constant for efficiency
      - type: 'timeseries'
        title: 'Requests'
        query: |
          name != null and kind == "server" and ("{{var-resource}}" == "" or name == "{{var-resource}}")
          | extend resource = case(name in {{const-top_resources}}, name, "Others")
          | summarize count() by bin_auto(timestamp), resource
          | order by timestamp desc
          | limit 2000
        unit: reqs
        layout: { w: 4, h: 3 }

      - type: 'timeseries_line'
        title: 'P95 Latency'
        query: |
          name != null and kind == "server" and duration != null and ("{{var-resource}}" == "" or name == "{{var-resource}}")
          | extend resource = case(name in {{const-top_resources}}, name, "Others")
          | summarize p95(duration) by bin_auto(timestamp), resource
          | order by timestamp desc
          | limit 2000
        unit: ns
        layout: { w: 4, h: 3 }

      - type: 'timeseries'
        title: 'Errors'
        theme: 'roma'
        query: |
          name != null and kind == "server" and (status_code == "ERROR" or coalesce(attributes.http.response.status_code, 0) >= 400) and ("{{var-resource}}" == "" or name == "{{var-resource}}")
          | extend resource = case(name in {{const-top_resources}}, name, "Others")
          | summarize count() by bin_auto(timestamp), resource
          | order by timestamp desc
          | limit 2000
        unit: errors
        layout: { w: 4, h: 3 }

      # Full width resource table
      - type: table
        title: 'Resources Overview'
        layout: { w: 12, h: 8 }
        on_row_click:
          set_variable: resource
          value: '{{row.resource_name}}'
        columns:
          - field: resource_name
            title: Resource Name
          - field: requests
            title: Requests
            columnType: number
            progress: column_percent
          - field: total_time
            title: Total Time
            columnType: duration
            unit: s
            progress: column_percent
          - field: p95_latency
            title: P95 Latency
            columnType: duration
            unit: ms
            progress: column_percent
          - field: errors
            title: Errors
            columnType: number
            progress: column_percent
            progress_variant: error
          - field: error_rate
            title: Error Rate (%)
            progress: value_percent
            progress_variant: error
        sql: |
          SELECT 
            name as resource_name,
            COUNT(*)::text as requests,
            ROUND((SUM(duration) / 1e9)::numeric, 2)::text as total_time,
            ROUND((approx_percentile(0.95, percentile_agg(duration))::numeric / 1e6), 2)::text as p95_latency,
            COUNT(*) FILTER (WHERE status_code = 'ERROR' OR COALESCE(attributes___http___response___status_code, 0) >= 400)::text as errors,
            ROUND((COUNT(*) FILTER (WHERE status_code = 'ERROR' OR COALESCE(attributes___http___response___status_code, 0) >= 400) * 100.0 / GREATEST(1, COUNT(*)))::numeric, 2)::text as error_rate
          FROM otel_logs_and_spans
          WHERE project_id='{{project_id}}'
            AND name IS NOT NULL
            AND kind = 'server'
            {{time_filter}}
          GROUP BY name
          ORDER BY COUNT(*) DESC
          LIMIT 100

  - name: Traces
    icon: activity
    widgets:
      # Trace Overview Stats
      - type: group
        title: Tracing Overview
        layout: { w: 12, h: 4 }
        children:
          - type: 'timeseries_stat'
            title: 'Total Spans'
            icon: list-tree
            query: |
              kind != null
              | summarize count() by bin_auto(timestamp)
              | order by timestamp desc
              | limit 200
            unit: spans
            layout: { w: 3, h: 2 }

          - type: 'stat'
            title: 'Error Rate'
            icon: bug
            query: |
              kind != null
              | summarize round(countif(status_code == "ERROR") * 100.0 / count(), 2)
            unit: '%'
            layout: { w: 3, h: 2 }

          - type: 'stat'
            title: 'Avg Trace Duration'
            icon: activity
            query: |
              parent_id == "" and duration != null
              | summarize round(avg(duration) / 1e6, 2)
            unit: ms
            layout: { w: 3, h: 2 }

          - type: 'stat'
            title: 'Traces'
            icon: route
            query: |
              parent_id == ""
              | summarize dcount(context.trace_id)
            unit: traces
            layout: { w: 3, h: 2 }

      # Span Rate by Service
      - type: 'timeseries'
        title: 'Span Rate by Service'
        query: |
          resource.service.name != null and ("{{var-service}}" == "" or resource.service.name == "{{var-service}}")
          | summarize count() / 5.0 by bin_auto(timestamp), resource.service.name
          | order by timestamp desc
          | limit 10000
        unit: spans/min
        layout: { w: 6, h: 4 }

      # Span Duration by Operation
      - type: 'timeseries'
        title: 'Span Duration by Operation'
        sql: |
          WITH operation_stats AS (
            SELECT
              name,
              AVG(duration) as avg_duration_ns
            FROM otel_logs_and_spans
            WHERE project_id='{{project_id}}'
              AND name IS NOT NULL
              AND ('{{var-service}}' = '' OR resource___service___name = '{{var-service}}')
              AND duration IS NOT NULL
              {{time_filter}}
            GROUP BY name
            ORDER BY avg_duration_ns DESC
            LIMIT 10
          )
          SELECT
            extract(epoch from time_bucket('{{rollup_interval}}', timestamp))::integer AS time,
            o.name,
            AVG(o.duration)::float as value
          FROM otel_logs_and_spans o
          INNER JOIN operation_stats s ON o.name = s.name
          WHERE o.project_id='{{project_id}}'
            AND ('{{var-service}}' = '' OR o.resource___service___name = '{{var-service}}')
            AND o.duration IS NOT NULL
            {{time_filter}}
          GROUP BY time, o.name
          ORDER BY time DESC
        unit: ns
        layout: { w: 6, h: 4 }

      # Trace List
      - type: traces
        title: 'Recent Traces'
        layout: { w: 12, h: 9 }
        columns:
          - field: resource_name
            title: Resource
          - field: span_name
            title: Span
            columnType: number
          - field: total_time
            title: Avg Duration
            columnType: duration
          - field: span_count
            title: Trace Count
            columnType: number
          - field: latency_breakdown
            title: Latency breakdown
        sql: |
          SELECT
            COALESCE(resource___service___name,'Unknown'),
            name,
            ROUND(AVG(duration/1000000), 2)::text AS avg_duration,
            COUNT(*)::text AS span_count,
            MIN(context___trace_id) AS trace_id
          FROM otel_logs_and_spans
          WHERE project_id='{{project_id}}'
            AND (parent_id = '' OR parent_id IS NULL) 
            AND name IS NOT NULL
            AND duration IS NOT NULL
            AND ('{{var-service}}' = '' OR resource___service___name = '{{var-service}}')
            {{time_filter}}
          GROUP BY  resource___service___name, name
          ORDER BY avg_duration DESC
          LIMIT 20

  - name: Logs
    icon: file-text
    widgets:
      # Log Stats
      - type: group
        title: Log Overview
        layout: { w: 12, h: 4 }
        children:
          - type: 'timeseries_stat'
            title: 'Total Logs'
            icon: file-text
            query: |
              body != null
              | summarize count() by bin_auto(timestamp)
              | order by timestamp desc
              | limit 200
            unit: logs
            layout: { w: 3, h: 2 }

          - type: 'stat'
            title: 'Error Logs'
            icon: alert-triangle
            query: |
              level in ("ERROR", "FATAL")
              | summarize count()
            unit: logs
            layout: { w: 3, h: 2 }

          - type: 'stat'
            title: 'Warn Logs'
            icon: alert-circle
            query: |
              level == "WARN"
              | summarize count()
            unit: logs
            layout: { w: 3, h: 2 }

          - type: 'stat'
            title: 'Log Sources'
            icon: server
            query: |
              resource.service.name != null
              | summarize dcount(resource.service.name)
            unit: services
            layout: { w: 3, h: 2 }

      # Log Volume Time Series
      - type: 'timeseries'
        title: 'Log Volume by Level'
        query: |
          level != null and ("{{var-service}}" == "" or resource.service.name == "{{var-service}}")
          | summarize count() by bin_auto(timestamp), level
          | order by timestamp desc
          | limit 10000
        layout: { w: 6, h: 4 }

      # Error Pattern Analysis
      - type: 'timeseries'
        title: 'Error Log Trends'
        theme: 'roma'
        sql: |
          WITH service_stats AS (
            SELECT 
              resource___service___name,
              COUNT(*) as error_count
            FROM otel_logs_and_spans
            WHERE project_id='{{project_id}}'
              AND level IN ('ERROR', 'FATAL')
              AND ('{{var-service}}' = '' OR resource___service___name = '{{var-service}}')
              {{time_filter}}
            GROUP BY resource___service___name
            ORDER BY error_count DESC
            LIMIT 10
          )
          SELECT 
            extract(epoch from time_bucket('{{rollup_interval}}', timestamp))::integer AS time,
            o.resource___service___name as service_name,
            COUNT(*)::float as count
          FROM otel_logs_and_spans o
          INNER JOIN service_stats s ON o.resource___service___name = s.resource___service___name
          WHERE o.project_id='{{project_id}}'
            AND o.level IN ('ERROR', 'FATAL')
            AND ('{{var-service}}' = '' OR o.resource___service___name = '{{var-service}}')
            {{time_filter}}
          GROUP BY time, service_name
          ORDER BY time DESC
        layout: { w: 6, h: 4 }

      # Log Stream
      - type: logs
        title: 'Log Stream'
        layout: { w: 12, h: 8 }
        sql: |
          SELECT *
          FROM otel_logs_and_spans
          WHERE project_id='{{project_id}}'
            AND body IS NOT NULL
            AND ('{{var-service}}' = '' OR resource___service___name = '{{var-service}}')
            AND ('{{var-resource}}' = '' OR name = '{{var-resource}}')
            {{time_filter}}
          ORDER BY timestamp DESC
          LIMIT 500

  - name: Databases
    icon: database
    widgets:
      # Database Overview Table
      - type: table
        title: Database Systems
        layout: { w: 12, h: 5 }
        on_row_click:
          set_variable: database
          value: '{{row.db_system}}'
        columns:
          - field: db_system
            title: Database Type
          - field: operations
            title: Operations
            columnType: number
            progress: column_percent
          - field: avg_duration
            title: Avg Duration
            columnType: duration
            unit: ms
            progress: column_percent
          - field: error_rate
            title: Error Rate
            unit: '%'
            progress: value_percent
            progress_variant: error
          - field: throughput
            title: Throughput
            columnType: number
            unit: ops/min
            progress: column_percent
        sql: |
          SELECT
            attributes___db___system___name as db_system,
            COUNT(*)::text as operations,
            ROUND((AVG(duration) / 1e6)::numeric, 2)::text as avg_duration,
            ROUND((COUNT(*) FILTER (WHERE status_code = 'ERROR') * 100.0 / GREATEST(1, COUNT(*)))::numeric, 2)::text as error_rate,
            ROUND((COUNT(*)::float / GREATEST(1, EXTRACT(EPOCH FROM (MAX(timestamp) - MIN(timestamp))) / 60))::numeric, 2)::text as throughput
          FROM otel_logs_and_spans
          WHERE project_id='{{project_id}}'
            AND attributes___db___system___name IS NOT NULL
            AND duration IS NOT NULL
            {{time_filter}}
          GROUP BY db_system
          ORDER BY COUNT(*) DESC

      # Database Performance Metrics
      - type: group
        title: Database Metrics
        layout: { w: 12, h: 4 }
        children:
          - type: 'timeseries_stat'
            title: 'Total Queries'
            icon: database
            query: |
              attributes.db.system.name != null and ("{{var-database}}" == "" or attributes.db.system.name == "{{var-database}}")
              | summarize count() by bin_auto(timestamp)
              | order by timestamp desc
              | limit 200
            unit: queries
            layout: { w: 3, h: 2 }

          - type: 'stat'
            title: 'Query Error Rate'
            icon: bug
            query: |
              attributes.db.system.name != null and ("{{var-database}}" == "" or attributes.db.system.name == "{{var-database}}")
              | summarize round(countif(status_code == "ERROR") * 100.0 / count(), 2)
            unit: '%'
            layout: { w: 3, h: 2 }

          - type: 'stat'
            title: 'Avg Query Time'
            icon: activity
            query: |
              attributes.db.system.name != null and duration != null and ("{{var-database}}" == "" or attributes.db.system.name == "{{var-database}}")
              | summarize round(avg(duration) / 1e6, 2)
            unit: ms
            layout: { w: 3, h: 2 }

          - type: 'stat'
            title: 'DB Operations'
            icon: layers
            query: |
              attributes.db.system.name != null and coalesce(attributes.db.operation.name, name) != null and ("{{var-database}}" == "" or attributes.db.system.name == "{{var-database}}")
              | summarize dcount(coalesce(attributes.db.operation.name, name))
            unit: types
            layout: { w: 3, h: 2 }

      # Query Performance by Operation
      - type: 'timeseries'
        title: 'Query Performance by Operation'
        query: |
          attributes.db.system.name != null and duration != null and coalesce(attributes.db.operation.name, name) != null and ("{{var-database}}" == "" or attributes.db.system.name == "{{var-database}}")
          | extend operation = coalesce(attributes.db.operation.name, name)
          | summarize avg(duration) by bin_auto(timestamp), operation
          | order by timestamp desc
          | limit 10000
        unit: ns
        layout: { w: 6, h: 4 }

      # Query Volume
      - type: 'timeseries'
        title: 'Query Volume by Database'
        query: |
          attributes.db.system.name != null and ("{{var-database}}" == "" or attributes.db.system.name == "{{var-database}}")
          | summarize count() by bin_auto(timestamp), attributes.db.system.name
          | order by timestamp desc
          | limit 10000
        unit: queries
        layout: { w: 6, h: 4 }

      # Slow Queries
      - type: table
        title: 'Slowest Queries'
        layout: { w: 12, h: 6 }
        columns:
          - field: query
            title: Query
          - field: operation
            title: Operation
          - field: database
            title: Database
          - field: duration_ms
            title: Duration
            columnType: duration
            unit: ms
            progress: column_percent
          - field: service
            title: Service
        sql: |
          SELECT
            COALESCE(attributes___db___query___text, attributes___db___query___summary, name) as query,
            COALESCE(attributes___db___operation___name, name) as operation,
            attributes___db___system___name as database,
            ROUND((duration / 1e6)::numeric, 2) as duration_ms,
            resource___service___name as service
          FROM otel_logs_and_spans
          WHERE project_id='{{project_id}}'
            AND (attributes___db___query___text IS NOT NULL OR attributes___db___query___summary IS NOT NULL OR name IS NOT NULL)
            AND ('{{var-database}}' = '' OR attributes___db___system___name = '{{var-database}}')
            {{time_filter}}
          ORDER BY duration DESC
          LIMIT 50

      # Database Errors
      - type: 'timeseries'
        title: 'Database Errors'
        theme: 'roma'
        query: |
          attributes.db.system.name != null and status_code == "ERROR" and ("{{var-database}}" == "" or attributes.db.system.name == "{{var-database}}")
          | summarize count() by bin_auto(timestamp), attributes.db.system.name
          | order by timestamp desc
          | limit 10000
        layout: { w: 6, h: 4 }

      # Connection Pool Status
      - type: 'timeseries'
        title: 'Database Connections'
        query: |
          name has "connection" and attributes.db.system.name != null and ("{{var-database}}" == "" or attributes.db.system.name == "{{var-database}}")
          | summarize count() by bin_auto(timestamp), coalesce(attributes.db.collection.name, "default")
          | order by timestamp desc
          | limit 10000
        layout: { w: 6, h: 4 }
