<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>easepick</title>
  <script src="https://cdn.jsdelivr.net/npm/@easepick/bundle@1.2.0/dist/index.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.2.1/build/global/luxon.min.js"></script>
</head>

<body>
  <my-element></my-element>
  <div>
  </div>




  <script type="module">
    import { LitElement, html, css } from 'https://cdn.jsdelivr.net/gh/lit/dist@3/core/lit-core.min.js';

    export class MyElement extends LitElement {
      static properties = {
        greeting: {},
        planet: {},
        filters: { value: [] },
        showFilterSearch: {}
      };

      static styles = css`
    .filter_content_container {
      width: 80%;
      display: flex;
      flex-direction: column;
      border: 1px solid lightgrey;
      height: 500px;
      margine-inline: auto;
    }

    .filter_content_container > input {
      padding: 8px 10px;
      border: 1px solid black
    }

    .component_container {
      position: relative;
      width: 800px
    }

    .filter_container {
      border: 1px solid grey;
      display: flex;
      align-items: center;
      padding: 5px 8px;
    }

    .planet {
      color: var(--planet-color, blue);
    }
    
    .filter_list {
      display: flex;
      flex-gap: 5px;
      align-items: center
    }
  `;

      constructor() {
        super();
        this.greeting = 'Hello';
        this.planet = 'World';
        this.filters = []
        this.showFilterSearch = false
        this.addEventListener('add-filter', this.handleChildEvent)
      }

      handleChildEvent(event) {
        this.filters = [...this.filters, event.detail.filter]
        this.showFilterSearch = false
      }

      render() {
        return html`
  <div class="component_container">
    <div class="filter_container">
            <div class="filter_list">
             ${this.filters.map(
          (filter) => html`
                   <button style="margin-right:3px">${filter}</button>
                 `
        )}
         </div>
     ${this.filters.length == 0 ?
            html`<span style="color: lightgrey; cursor:pointer" @click=${() => this.showFilterSearch = true} >Click to add filter...</span>`
            :
            html`<button @click=${() => this.showFilterSearch = true}>Add</button>`
          }
    </div>
    ${this.showFilterSearch ? html`<filter-suggestions></filter-suggestions>` : null}
  </div>
    `;
      }

    }
    customElements.define('my-element', MyElement);


    class Filter extends LitElement {
      filters = [
        "method", "request_body", "request_headers", "response_body", "response_headers",
        "host", "url_path", "raw_url", "referer", "status_code", "query_params", "path_params"
      ]

      string_operators = ["=", "!="]
      number_operators = ["=", "!=", ">=", "<="]

      filterAutoComplete = {
        "method": {
          operators: this.string_operators,
          values: [`"GET"`, `"POST"`, `"PUT"`, `"DELETE"`, `"PATCH"`, `"HEAD"`]
        },
        "status_code": {
          operators: this.number_operators,
          values: [200, 201, 400, 404, 500, 300, 100]
        },
        "others": { operators: this.string_operators, values: [""] }
      }

      static properties = {
        matches: {},
        inputVal: {},
      }

      constructor() {
        super()
        this.inputVal = ''
        this.matches = []
      }

      render() {
        return html`
        <div class="filter_content_container">
          <input type="text" @input=${this.handleChange} .value=${this.inputVal} @change=${(e) => this.triggerCustomEvent(e.target.value)} />
          <div>
            <div style="display: flex; flex-direction: column; flex-gap:5px">
             ${this.matches.map(
          (match) => html`
                   <button @click=${() => this.autoCompleteInput(match)}>${match}</button>
                 `
        )}
         </div>
          </div>
        </div>
        `
      }

      autoCompleteInput(val) {
        this.inputVal = val + " "
        this.triggerCustomEvent(val)
      }

      isValidFilter(filter) {
        const parts = filter.trim().split(/\s*([=<>!]+)\s*/);
        if (parts.length !== 3) {
          return false;
        }

        const [field, operator, value] = parts;
        if (!field || !value) {
          return false
        }
        return true;
      }

      triggerCustomEvent(value) {
        if (!this.isValidFilter(value)) return
        const event = new CustomEvent('add-filter', {
          detail: {
            filter: value,
          },
          bubbles: true,
          composed: true,
        });
        this.dispatchEvent(event);
      }

      handleChange(event) {
        if (event.key === "Enter") {
          this.triggerCustomEvent(event.target.value)
          return
        }
        this.inputVal = event.target.value.trim()
        let filters = this.filters.filter(v => v.startsWith(this.inputVal) || this.inputVal.startsWith(v))
        let auto_complete = []
        filters.forEach(filter => {
          let target = filter
          if (target !== "method" && target !== "status_code") {
            target = "others"
          }
          let target_info = this.filterAutoComplete[target]

          if (filter == this.inputVal.trim() || filter.length > this.inputVal.length) {
            for (let op of target_info.operators) {
              auto_complete.push(`${filter} ${op}`)
            }
          } else {
            target_info.values.forEach(v => {
              auto_complete.push(`${this.inputVal} ${v}`)

            })
          }

        })
        this.matches = auto_complete
      }
    }
    customElements.define('filter-suggestions', Filter)

  </script>


  <script>
    const picker = new easepick.create({
      element: '#dpbt',
      css: [
        'https://cdn.jsdelivr.net/npm/@easepick/bundle@1.2.0/dist/index.css',
      ],
      plugins: ['RangePlugin', 'PresetPlugin', 'TimePlugin'],
      autoApply: false,
      setup(picker) {
        picker.on('select', (e) => {
          const start = JSON.stringify(e.detail.start).slice(1, -1);
          const end = JSON.stringify(e.detail.end).slice(1, -1);
          document.getElementById("startTime").value = start;
          document.getElementById("endTime").value = end;

          const url = new URL(window.location.href);
          url.searchParams.set('from', start);
          url.searchParams.set('to', end);
          window.history.replaceState(null, null, url);

          console.log(start);
          console.log(luxon.DateTime.fromISO(start));
        });
      },
    });
    window.picker = picker;
  </script>

</body>

</html>